<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" />
		<meta
			name="viewport"
			content="initial-scale=1,maximum-scale=1,user-scalable=no"
		/>
		<title>IGeometry</title>
		<script src="https://js.arcgis.com/4.4"></script>
		<link rel="stylesheet" href="https://js.arcgis.com/4.4/esri/css/main.css" />
	</head>
	<body>
		<table align="center">
			<tr>
				<td valign="top">
					<div id="toc"></div>
				</td>
				<td>
					<div id="mapview" style="width:600px;height:600px;margin:0 auto;">
						map goes here
					</div>
				</td>
			</tr>
		</table>

		<div id="buttons" align="center"></div>

		<style>
			html,
			body,
			#viewDiv {
				height: 100%;
				width: 100%;
				margin: 0;
				padding: 0;
				align-content: center;
			}
			#optionsDiv {
				background-color: white;
				color: black;
				padding: 6px;
				max-width: 400px;
				align-content: right;
			}
		</style>

		<script>
			let mapview;
			let map;
			let layer;
			let r;
			let Request;
			let selectedService;

			//second commit
			require([
				"esri/Map",
				"esri/views/MapView",
				"esri/request",
				"esri/layers/MapImageLayer",
				"esri/widgets/Legend"
			], function(Map, MapView, esriRequest, FeatureLayer, Legend) {
				Request = esriRequest;
				generateBasemaps();

				var PermitsLayer = new FeatureLayer({
					url:
						"https://arcgis.sefnco.com/arcgis/rest/services/Permits_joined/FeatureServer/13",

					outFields: ["*"]
				});

				map = new Map({
					basemap: "topo-vector",
						});

				//mapview = new MapView(viewoptions);
				var mapview = new MapView({
					container: "mapview",
					map: map,

					popup: {
						autoOpenEnabled: false,
						dockEnabled: true,
						dockOptions: {
							// dock popup at bottom-right side of view
							buttonEnabled: false,
							breakpoint: false,
							position: "bottom-right"
						}
					}
				});
				map.add(PermitsLayer, 0);
				let viewoptions = {
					container: "mapview",
					map: map,
					center: [-117.1616394868625, 32.7127455035969],
					scale: 10000
				};


				var legend = new Legend({
					view: mapview,
					layerInfos: [
						{
							layer: PermitsLayer
						}
					]
				});
				//let legend = new Legend({ view: mapview });

				mapview.ui.add(legend, "bottom-left");
				mapview.ui.add("optionsDiv", "top-right");

				// additional query fields initially set to null for basic query
				var distance = null;
				var units = null;

				//create graphic for mouse point click
				var pointGraphic = new Graphic({
					symbol: {
						type: "simple-marker", // autocasts as new SimpleMarkerSymbol()
						color: [0, 0, 139],
						outline: {
							color: [255, 255, 255],
							width: 1.5
						}
					}
				});

				// when query type changes, set appropriate values
				var queryOpts = document.getElementById("query-type");

				queryOpts.addEventListener("change", function() {
					switch (queryOpts.value) {
						// values set for distance query
						case "distance":
							distance = 0.5;
							units = "miles";
							break;
						default:
							// Default set to basic query
							distance = null;
							units = null;
					}
				});
				layer.load().then(function() {
					// Set the view extent to the data extent
					view.extent = layer.fullExtent;
					layer.popupTemplate = layer.createPopupTemplate();
				});

				view.on("click", function(event) {
					view.graphics.remove(pointGraphic);
					queryFeatures(event);
				});

				function queryFeatures(screenPoint) {
					const point = view.toMap(screenPoint);
					layer
						.queryFeatures({
							geometry: point,
							// distance and units will be null if basic query selected
							distance: distance,
							units: units,
							spatialRelationship: "intersects",
							returnGeometry: false,
							outFields: ["*"]
						})
						.then(function(featureSet) {
							// set graphic location to mouse pointer and add to mapview
							pointGraphic.geometry = point;
							view.graphics.add(pointGraphic);
							// open popup of query result
							view.popup.open({
								location: point,
								features: featureSet.features,
								featureMenuOpen: true
							});
						});
				}

				let url =
					//"https://sampleserver6.arcgisonline.com/arcgis/rest/services?f=json";
					"https://arcgis.sefnco.com/arcgis/rest/services?f=json";
				let options = { responseType: "json" };
				//getCount(4);
				//getCount(9);

				function onChangeServiceMap() {
					selectedService =
						lstservices.options[lstservices.selectedIndex].textContent;

					map.removeAll();
					map.add(layer);

					//wait until the layer is loaded.
					layer.then(() => {
						let toc = document.getElementById("toc");
						toc.innerHTML = "";
						let layerlist = document.createElement("ul");
						toc.appendChild(layerlist);
						//populate layers in list
						//populateLayerRecursive(layer, layerlist);

						mapview.goTo(layer.fullExtent);
					});
				}
			});

			//Populate layer subitems in the input element

			//Generate list of buttons for basemaps
			function generateBasemaps() {
				let basemaps = [];

				//"streets", "satellite", "hybrid", "terrain", "topo", "gray", "dark-gray", "oceans", "national-geographic", "osm", "dark-gray-vector", "gray-vector", "streets-vector", "topo-vector", "streets-night-vector", "streets-relief-vector", "streets-navigation-vector"
				basemaps.push("satellite");
				basemaps.push("topo");
				basemaps.push("osm");
				basemaps.push("terrain");
				basemaps.push("dark-gray");
				basemaps.push("national-geographic");
				basemaps.push("streets-night-vector");

				//let setBasemap = function (e) { map.basemap = e.target.id }
				let setBasemap = (e) => (map.basemap = e.target.id);

				for (let i = 0; i < basemaps.length; i++) {
					let buttons = document.getElementById("buttons");
					let button = document.createElement("button");
					button.id = basemaps[i];
					button.textContent = basemaps[i];

					button.addEventListener("click", setBasemap);
					buttons.appendChild(button);
				}
			}
		</script>

		<div id="optionsDiv" class="esri-widget">
			<p>
				Select a query type and click a point on the map to view the results.
			</p>
			<select id="query-type" class="esri-widget">
				<option value="basic">Basic Query</option>
				<option value="distance">Query By Distance</option>
			</select>
		</div>
	</body>
</html>

